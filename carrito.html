<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Materiales Pay√°n | Carrito de compras</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <!-- Barra superior -->
    <div class="top-bar">
        <div class="container top-bar-content">
            <span>‚úî Env√≠o gratuito dentro de 5 km a la redonda.</span>
            <span>üì¶ Los pedidos realizados antes de las 11:00 se enviar√°n el mismo d√≠a.</span>
        </div>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="container nav-container">
            <a href="index.html" class="logo">MATERIALES PAY√ÅN</a>

            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">INICIO</a></li>
                    <li><a href="productos.html">PRODUCTOS Y SERVICIOS</a></li>
                    <li><a href="quienes-somos.html">QUI√âNES SOMOS?</a></li>
                    <li><a href="preguntas.html">PREGUNTAS FRECUENTES</a></li>
                    <li><a href="agregados.html">AGREGADOS</a></li>
                    <li><a href="contacto.html">CONTACTO</a></li>
                </ul>
            </nav>

            <div class="nav-icons">
                <button class="icon-btn" aria-label="Favoritos" type="button">‚ù§</button>
                <a href="carrito.html" class="icon-btn" aria-label="Carrito">üõí</a>
            </div>
        </div>
    </header>

    <main>
        <!-- Encabezado del carrito -->
        <section class="cart-header">
            <div class="container">
                <h1>Carrito de compras</h1>
                <p>
                    Revisa los materiales que has agregado a tu pedido. Puedes ajustar las cantidades, eliminar productos
                    y comprobar el total antes de continuar al pago en una plataforma segura.
                </p>
            </div>
        </section>

        <!-- Contenido del carrito -->
        <section class="cart-main">
            <div class="container cart-layout">
                <!-- Lista de productos -->
                <div class="cart-items">
                    <div class="cart-items-header">
                        <span>Producto</span>
                        <span>Precio</span>
                        <span>Cantidad</span>
                        <span>Subtotal</span>
                        <span></span>
                    </div>

                    <!-- AQU√ç se pintar√°n los productos del carrito -->
                    <div id="cart-items-container"></div>

                    <!-- Vaciar carrito -->
                    <div class="cart-actions">
                        <button class="link-btn clear-cart" type="button">Vaciar carrito</button>
                        <a href="index.html#catalogo" class="link-btn">Seguir comprando</a>
                    </div>
                </div>

                <!-- Resumen del pedido -->
                <aside class="cart-summary">
                    <h2>Resumen del pedido</h2>

                    <!-- ‚úÖ Datos del cliente (NUEVO) -->
                    <div class="cart-customer-box" style="margin-bottom: 1.2rem;">
                        <h3 style="font-size: 1.05rem; margin-bottom: 0.6rem; color: var(--negro);">
                            Datos de contacto
                        </h3>

                        <label style="font-size:0.9rem; font-weight:500;">Nombre</label>
                        <input id="customerName" type="text" placeholder="Tu nombre"
                               style="width:100%; padding:0.55rem 0.6rem; margin:0.25rem 0 0.65rem; border:1px solid var(--gris-borde); font-family:inherit;">

                        <label style="font-size:0.9rem; font-weight:500;">Tel√©fono WhatsApp</label>
                        <input id="customerPhone" type="tel" placeholder="Ej. 56xxxxxxxx"
                               style="width:100%; padding:0.55rem 0.6rem; margin:0.25rem 0 0.2rem; border:1px solid var(--gris-borde); font-family:inherit;">

                        <p style="font-size:0.82rem; color: var(--gris-texto); margin-top: 0.35rem;">
                            Te contactaremos por WhatsApp para confirmar entrega.
                        </p>
                    </div>

                    <div class="cart-summary-row">
                        <span>Subtotal</span>
                        <span id="cart-subtotal">MXN 0.00</span>
                    </div>

                    <!-- ‚úÖ Env√≠o fijo informativo -->
                    <div class="cart-summary-row">
                        <span>Env√≠o (dentro de 5 km)</span>
                        <span>Gratis</span>
                    </div>

                    <div class="cart-summary-row">
                        <span>Descuento</span>
                        <span id="cart-discount">MXN 0.00</span>
                    </div>

                    <hr class="section-divider">

                    <div class="cart-summary-total">
                        <span>Total</span>
                        <span id="cart-total">MXN 0.00</span>
                    </div>

                    <p class="cart-summary-note">
                        El total mostrado es informativo. El env√≠o es gratis dentro de 5 km.
                        Al continuar, ser√°s redirigido a una plataforma de pago segura
                        donde podr√°s confirmar tu pedido.
                    </p>

                    <button class="btn-primary cart-pay-btn" id="btnProcederPago" type="button">
                        Proceder al pago seguro
                    </button>

                    <p class="cart-summary-small">
                        Factura Masiva
                    </p>
                </aside>
            </div>
        </section>
    </main>

    <br><br>

    <!-- Footer -->
    <footer class="footer">
        <div class="container footer-content">
            <span>¬© 2025 Materiales Pay√°n</span>
            <span>Innova LS Tech</span>
        </div>
    </footer>

    <!-- ‚úÖ JavaScript del carrito + checkout -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {

        const itemsContainer = document.getElementById("cart-items-container");
        const subtotalEl = document.getElementById("cart-subtotal");
        const totalEl = document.getElementById("cart-total");
        const discountEl = document.getElementById("cart-discount");
        const clearCartBtn = document.querySelector(".clear-cart");
        const payBtn = document.getElementById("btnProcederPago");

        // ‚úÖ Inputs cliente (NUEVO)
        const nameInput = document.getElementById("customerName");
        const phoneInput = document.getElementById("customerPhone");

        const BACKEND_URL = "https://materiales-payan-backend.onrender.com";

        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        function formatMoney(amount) {
            const num = Number(amount) || 0;
            return "MXN " + num.toLocaleString("es-MX", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function saveCart() {
            localStorage.setItem("cart", JSON.stringify(cart));
        }

        // ‚úÖ Guardar/leer cliente (NUEVO)
        function saveCustomer(customer) {
            localStorage.setItem("customer", JSON.stringify(customer));
        }
        function loadCustomer() {
            try {
                return JSON.parse(localStorage.getItem("customer")) || null;
            } catch {
                return null;
            }
        }
        function fillCustomerOnLoad() {
            const c = loadCustomer();
            if (!c) return;
            if (nameInput) nameInput.value = c.name || "";
            if (phoneInput) phoneInput.value = c.phone || "";
        }
        function getCustomerFromInputs() {
            return {
                name: (nameInput?.value || "").trim(),
                phone: (phoneInput?.value || "").trim()
            };
        }

        function updateTotals() {
            let subtotal = 0;
            const items = document.querySelectorAll(".cart-item");

            if (!items.length) {
                subtotalEl.textContent = formatMoney(0);
                discountEl.textContent = formatMoney(0);
                totalEl.textContent = formatMoney(0);
                return;
            }

            items.forEach(item => {
                const price = parseFloat(item.dataset.price) || 0;
                const qtyInput = item.querySelector(".qty-input");
                let quantity = parseInt(qtyInput.value, 10) || 1;

                if (quantity < 1) quantity = 1;
                qtyInput.value = quantity;

                const itemSubtotal = price * quantity;
                const subtotalCell = item.querySelector(".cart-item-subtotal");
                if (subtotalCell) subtotalCell.textContent = formatMoney(itemSubtotal);

                subtotal += itemSubtotal;
            });

            const discount = 0;
            subtotalEl.textContent = formatMoney(subtotal);
            discountEl.textContent = formatMoney(discount);

            // ‚úÖ Sin c√°lculo de env√≠o: total = subtotal - descuento
            totalEl.textContent = formatMoney(subtotal - discount);
        }

        function renderCart() {
            itemsContainer.innerHTML = "";

            if (!cart.length) {
                itemsContainer.innerHTML = `
                    <p class="empty-cart">
                        Tu carrito est√° vac√≠o.
                        <a href="index.html#catalogo">Ver productos</a>
                    </p>
                `;
                updateTotals();
                return;
            }

            cart.forEach(item => {
                const div = document.createElement("div");
                div.classList.add("cart-item");
                div.dataset.price = Number(item.price) || 0;
                div.dataset.id = String(item.id || "");

                const safeName = String(item.name || "Producto");
                const safeImg = String(item.img || "");
                const safeQty = Math.max(1, parseInt(item.quantity, 10) || 1);
                const safePrice = Number(item.price) || 0;

                div.innerHTML = `
                    <div class="cart-item-product">
                        <img src="${safeImg}" alt="${safeName}">
                        <div>
                            <h3>${safeName}</h3>
                        </div>
                    </div>
                    <div class="cart-item-price">
                        ${formatMoney(safePrice)}
                    </div>
                    <div class="cart-item-qty">
                        <button class="qty-btn minus" data-action="minus" type="button">‚àí</button>
                        <input type="number" min="1" value="${safeQty}" class="qty-input">
                        <button class="qty-btn plus" data-action="plus" type="button">+</button>
                    </div>
                    <div class="cart-item-subtotal">
                        ${formatMoney(safePrice * safeQty)}
                    </div>
                    <div class="cart-item-remove">
                        <button class="link-btn remove-item" type="button">Eliminar</button>
                    </div>
                `;

                itemsContainer.appendChild(div);
            });

            updateTotals();
        }

        // +, -, eliminar
        itemsContainer.addEventListener("click", (e) => {
            const target = e.target;
            const itemDiv = target.closest(".cart-item");
            if (!itemDiv) return;

            const id = itemDiv.dataset.id;
            const index = cart.findIndex(p => String(p.id) === String(id));
            if (index === -1) return;

            if (target.classList.contains("qty-btn")) {
                const action = target.dataset.action;
                const qtyInput = itemDiv.querySelector(".qty-input");
                let qty = parseInt(qtyInput.value, 10) || 1;

                if (action === "plus") qty++;
                if (action === "minus" && qty > 1) qty--;

                qtyInput.value = qty;
                cart[index].quantity = qty;

                saveCart();
                updateTotals();
            }

            if (target.classList.contains("remove-item")) {
                cart.splice(index, 1);
                saveCart();
                renderCart();
            }
        });

        // cambio manual qty
        itemsContainer.addEventListener("change", (e) => {
            if (!e.target.classList.contains("qty-input")) return;

            const itemDiv = e.target.closest(".cart-item");
            if (!itemDiv) return;

            const id = itemDiv.dataset.id;
            const index = cart.findIndex(p => String(p.id) === String(id));
            if (index === -1) return;

            let qty = parseInt(e.target.value, 10) || 1;
            if (qty < 1) qty = 1;
            e.target.value = qty;

            cart[index].quantity = qty;
            saveCart();
            updateTotals();
        });

        // vaciar carrito
        if (clearCartBtn) {
            clearCartBtn.addEventListener("click", () => {
                cart = [];
                saveCart();
                renderCart();
            });
        }

        // ‚úÖ Proceder al pago seguro (carrito + cliente)
        if (payBtn) {
            payBtn.addEventListener("click", async () => {
                const currentCart = JSON.parse(localStorage.getItem("cart")) || [];

                if (!currentCart.length) {
                    alert("Tu carrito est√° vac√≠o.");
                    return;
                }

                const customer = getCustomerFromInputs();

                if (!customer.name || !customer.phone) {
                    alert("Por favor ingresa tu nombre y tu tel√©fono WhatsApp antes de pagar.");
                    return;
                }

                // Guardamos para experiencia m√°s c√≥moda
                saveCustomer(customer);

                payBtn.disabled = true;
                const originalText = payBtn.textContent;
                payBtn.textContent = "Generando pago...";

                try {
                    const res = await fetch(`${BACKEND_URL}/api/checkout`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            cart: currentCart,
                            customer,       // ‚úÖ NUEVO (para metadata)
                            shippingCost: 0 // opcional por compatibilidad
                        })
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        console.error(data);
                        alert(data.error || "No se pudo generar el pago.");
                        return;
                    }

                    if (data.checkoutUrl) {
                        window.location.href = data.checkoutUrl;
                    } else {
                        alert("No se recibi√≥ URL de checkout.");
                    }

                } catch (err) {
                    console.error(err);
                    alert("Error conectando con el servidor de pagos.");
                } finally {
                    payBtn.disabled = false;
                    payBtn.textContent = originalText;
                }
            });
        }

        // ‚úÖ INIT
        fillCustomerOnLoad();
        renderCart();
    });
    </script>

</body>
</html>
