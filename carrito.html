<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Materiales Pay√°n | Carrito de compras</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <!-- Barra superior -->
    <div class="top-bar">
        <div class="container top-bar-content">
            <span>‚úî Env√≠o gratuito dentro de 5 km a la redonda.</span>
            <span>üì¶ Los pedidos realizados antes de las 11:00 se enviar√°n el mismo d√≠a.</span>
        </div>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="container nav-container">
            <a href="index.html" class="logo">MATERIALES PAY√ÅN</a>

            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">INICIO</a></li>
                    <li><a href="productos.html">PRODUCTOS Y SERVICIOS</a></li>
                    <li><a href="quienes-somos.html">QUI√âNES SOMOS?</a></li>
                    <li><a href="preguntas.html">PREGUNTAS FRECUENTES</a></li>
                    <li><a href="agregados.html">AGREGADOS</a></li>
                    <li><a href="contacto.html">CONTACTO</a></li>
                </ul>
            </nav>

            <div class="nav-icons">
                <button class="icon-btn" aria-label="Favoritos">‚ù§</button>
                <a href="carrito.html" class="icon-btn" aria-label="Carrito">üõí</a>
            </div>
        </div>
    </header>

    <main>
        <!-- Encabezado del carrito -->
        <section class="cart-header">
            <div class="container">
                <h1>Carrito de compras</h1>
                <p>
                    Revisa los materiales que has agregado a tu pedido. Puedes ajustar las cantidades, eliminar productos
                    y comprobar el total antes de continuar al pago en una plataforma segura.
                </p>
            </div>
        </section>

        <!-- Contenido del carrito -->
        <section class="cart-main">
            <div class="container cart-layout">
                <!-- Lista de productos -->
                <div class="cart-items">
                    <div class="cart-items-header">
                        <span>Producto</span>
                        <span>Precio</span>
                        <span>Cantidad</span>
                        <span>Subtotal</span>
                        <span></span>
                    </div>

                    <!-- AQU√ç se pintar√°n los productos del carrito -->
                    <div id="cart-items-container"></div>

                    <!-- Vaciar carrito -->
                    <div class="cart-actions">
                        <button class="link-btn clear-cart">Vaciar carrito</button>
                        <a href="index.html#catalogo" class="link-btn">Seguir comprando</a>
                    </div>
                </div>

                <!-- Resumen del pedido -->
                <aside class="cart-summary">
                    <h2>Resumen del pedido</h2>

                    <div class="cart-summary-row">
                        <span>Subtotal</span>
                        <span id="cart-subtotal">MXN 0.00</span>
                    </div>

                    <div class="cart-summary-row">
                        <span>Env√≠o (dentro de 5 km)</span>
                        <span>Gratis</span>
                    </div>

                    <div class="cart-summary-row">
                        <span>Descuento</span>
                        <span id="cart-discount">MXN 0.00</span>
                    </div>

                    <hr class="section-divider">

                    <div class="cart-summary-total">
                        <span>Total</span>
                        <span id="cart-total">MXN 0.00</span>
                    </div>

                    <p class="cart-summary-note">
                        El total mostrado es informativo. Al continuar, ser√°s redirigido a una plataforma de pago segura
                        donde podr√°s confirmar tu pedido.
                    </p>

                    <button class="btn-primary cart-pay-btn" id="btnProcederPago">
                        Proceder al pago seguro
                    </button>

                    <p class="cart-summary-small">
                  
                    Factura Masiva
   
                    </p>
                </aside>
            </div>
        </section>
    </main>
<br>
<br>
    <!-- Footer -->
    <footer class="footer">
        <div class="container footer-content">
            <span>¬© 2025 Materiales Pay√°n</span>
            <span>Innova LS Tech</span>
        </div>
    </footer>

   <!-- JavaScript del carrito (lee localStorage, pinta productos y crea checkout con Mercado Pago) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const itemsContainer = document.getElementById("cart-items-container");
  const subtotalEl = document.getElementById("cart-subtotal");
  const totalEl = document.getElementById("cart-total");
  const discountEl = document.getElementById("cart-discount");
  const clearCartBtn = document.querySelector(".clear-cart");
  const payBtn = document.getElementById("btnProcederPago");

  const BACKEND_URL = "https://materiales-payan-backend.onrender.com";

  let cart = JSON.parse(localStorage.getItem("cart")) || [];

  function formatMoney(amount) {
    const num = Number(amount) || 0;
    return "MXN " + num.toLocaleString("es-MX", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function saveCart() {
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  function updateTotals() {
    let subtotal = 0;
    const items = document.querySelectorAll(".cart-item");

    if (items.length === 0) {
      subtotalEl.textContent = formatMoney(0);
      discountEl.textContent = formatMoney(0);
      totalEl.textContent = formatMoney(0);
      return;
    }

    items.forEach(item => {
      const price = parseFloat(item.dataset.price) || 0;
      const qtyInput = item.querySelector(".qty-input");
      let quantity = parseInt(qtyInput.value, 10) || 1;

      if (quantity < 1) quantity = 1;
      qtyInput.value = quantity;

      const itemSubtotal = price * quantity;
      const subtotalElItem = item.querySelector(".cart-item-subtotal");
      if (subtotalElItem) subtotalElItem.textContent = formatMoney(itemSubtotal);

      subtotal += itemSubtotal;
    });

    const discount = 0;
    subtotalEl.textContent = formatMoney(subtotal);
    discountEl.textContent = formatMoney(discount);
    totalEl.textContent = formatMoney(subtotal - discount);
  }

  function renderCart() {
    itemsContainer.innerHTML = "";

    if (!cart.length) {
      itemsContainer.innerHTML = `
        <p class="empty-cart">
          Tu carrito est√° vac√≠o.
          <a href="index.html#catalogo">Ver productos</a>
        </p>
      `;
      updateTotals();
      return;
    }

    cart.forEach(item => {
      const div = document.createElement("div");
      div.classList.add("cart-item");
      div.dataset.price = item.price;
      div.dataset.id = item.id;

      div.innerHTML = `
        <div class="cart-item-product">
          <img src="${item.img || ""}" alt="${item.name || "Producto"}">
          <div>
            <h3>${item.name || "Producto"}</h3>
          </div>
        </div>
        <div class="cart-item-price">
          ${formatMoney(item.price)}
        </div>
        <div class="cart-item-qty">
          <button class="qty-btn minus" data-action="minus">‚àí</button>
          <input type="number" min="1" value="${item.quantity || 1}" class="qty-input">
          <button class="qty-btn plus" data-action="plus">+</button>
        </div>
        <div class="cart-item-subtotal">
          ${formatMoney((item.price || 0) * (item.quantity || 1))}
        </div>
        <div class="cart-item-remove">
          <button class="link-btn remove-item">Eliminar</button>
        </div>
      `;

      itemsContainer.appendChild(div);
    });

    updateTotals();
  }

  // +, -, eliminar
  itemsContainer.addEventListener("click", (e) => {
    const target = e.target;
    const itemDiv = target.closest(".cart-item");
    if (!itemDiv) return;

    const id = itemDiv.dataset.id;
    const index = cart.findIndex(p => p.id === id);
    if (index === -1) return;

    if (target.classList.contains("qty-btn")) {
      const action = target.dataset.action;
      const qtyInput = itemDiv.querySelector(".qty-input");
      let qty = parseInt(qtyInput.value, 10) || 1;

      if (action === "plus") qty++;
      if (action === "minus" && qty > 1) qty--;

      qtyInput.value = qty;
      cart[index].quantity = qty;
      saveCart();
      updateTotals();
    }

    if (target.classList.contains("remove-item")) {
      cart.splice(index, 1);
      saveCart();
      renderCart();
    }
  });

  // cambio manual qty
  itemsContainer.addEventListener("change", (e) => {
    if (!e.target.classList.contains("qty-input")) return;

    const itemDiv = e.target.closest(".cart-item");
    if (!itemDiv) return;

    const id = itemDiv.dataset.id;
    const index = cart.findIndex(p => p.id === id);
    if (index === -1) return;

    let qty = parseInt(e.target.value, 10) || 1;
    if (qty < 1) qty = 1;
    e.target.value = qty;

    cart[index].quantity = qty;
    saveCart();
    updateTotals();
  });

  // vaciar carrito
  if (clearCartBtn) {
    clearCartBtn.addEventListener("click", () => {
      cart = [];
      saveCart();
      renderCart();
    });
  }

  // ‚úÖ pago real con backend
  if (payBtn) {
    payBtn.addEventListener("click", async () => {
      const currentCart = JSON.parse(localStorage.getItem("cart")) || [];

      if (!currentCart.length) {
        alert("Tu carrito est√° vac√≠o.");
        return;
      }

      payBtn.disabled = true;
      const originalText = payBtn.textContent;
      payBtn.textContent = "Generando pago...";

      try {
        const res = await fetch(`${BACKEND_URL}/api/checkout`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cart: currentCart })
        });

        const data = await res.json();

        if (!res.ok) {
          console.error(data);
          alert(data.error || "No se pudo generar el pago.");
          return;
        }

        if (data.checkoutUrl) {
          window.location.href = data.checkoutUrl;
        } else {
          alert("No se recibi√≥ URL de checkout.");
        }

      } catch (err) {
        console.error(err);
        alert("Error conectando con el servidor de pagos.");
      } finally {
        payBtn.disabled = false;
        payBtn.textContent = originalText;
      }
    });
  }

  renderCart();
});
</script>


</body>
</html>
